name: Update betterer

on:
  issue_comment:
    types:
      - created

jobs:
  update-betterer-aa:
    runs-on: ubuntu-latest
    if: ${{ github.event.comment.body == 'betterer:update' }}
    env:
      FORCE_COLOR: '1'
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Add comment
        uses: actions/github-script@v4
        with:
          script: |
            const {owner, repo} = context.issue
            github.reactions.createForIssueComment({
              owner,
              repo,
              comment_id: context.payload.comment.id,
              content: "+1",
            });
      - uses: actions/checkout@v2
      - name: Checkout Pull Request
        run: |
          hub pr checkout ${{ github.event.issue.number }}
      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 16.3
      - name: Install dependencies
        run: yarn --frozen-lockfile --non-interactive --no-progress
#      - name: Typecheck
#        uses: computerjazz/typescript-error-reporter-action@v1.0.11
#        with:
#          project: tsconfig-strict.json
#          repo_token: "${{ secrets.GITHUB_TOKEN }}"
      - name: Update Betterer
        id: run_betterer_update
        run: |
          set -o pipefail
          CI=0 yarn run betterer --update --reporter ./custom-betterer-reporter.js | sed -r "s/\x1B\[(([0-9]{1,2})?(;)?([0-9]{1,2})?)?[m,K,H,f,J]//g" | tee betterer-log.txt
          result=$?
          output="$(cat betterer-log.txt)"
          output="${output//$'\n'/\\n}"
          output_diff="$(git diff HEAD^:./ -- .betterer.results)"
          output_diff="${output_diff//$'\n'/\\n}"
          echo "::set-output name=betterer-output::$output"
          echo "::set-output name=betterer-output-diff::$output_diff"
          echo "::set-output name=betterer-result::$result"
          git diff HEAD^:./ -- .betterer.results
      - name: setup git config
        run: |
          # setup the username and email. I tend to use 'GitHub Actions Bot' with no email by default
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
      - name: commit
        run: |
          git add .betterer.results
          git commit -m "Updated Betterer results file"
          git push
      - name: Add comment
        uses: actions/github-script@v4
        env:
          BETTERER_OUTPUT: ${{ steps.run_betterer_update.outputs.betterer-output }}
          BETTERER_DIFF: ${{ steps.run_betterer_update.outputs.betterer-output-diff }}
        with:
          script: |
            let fixedIssuesCount
            let newIssuesCount
            function getNumber(text) {
              const numbers = text.match(/\d/g)
              const numberOrUndefined = Number(numbers.join(""))
              return numberOrUndefined || 0
            }
            const positiveGifs = [
              "https://i.giphy.com/media/5GoVLqeAOo6PK/giphy.webp",
              "https://i.giphy.com/media/PaSnUZW1EeypulsOwd/giphy.webp",
              "https://i.giphy.com/media/MOWPkhRAUbR7i/giphy.webp",
              "https://i.giphy.com/media/m4jqqr0kXABqw5a4nb/giphy.webp",
              "https://i.giphy.com/media/7aBE32jCr6lOhtuE9v/giphy.webp",
              "https://i.giphy.com/media/LcLmmj5br7gkEzjCcb/giphy.webp",
              "https://i.giphy.com/media/MCKQEmHkUyGf6/giphy.webp",
              "https://i.giphy.com/media/3o72FcJmLzIdYJdmDe/giphy.webp",
              "https://i.giphy.com/media/UO7RnQMiNpmIlHZWRT/giphy.webp",
            ]
            const negativeGifs = [
              "https://i.giphy.com/media/BEob5qwFkSJ7G/giphy.webp",
              "https://i.giphy.com/media/9Y5BbDSkSTiY8/giphy.webp",
              "https://i.giphy.com/media/l1KVaj5UcbHwrBMqI/giphy.webp",
              "https://i.giphy.com/media/M28rUlcjueKUE/giphy.webp",
              "https://i.giphy.com/media/2rtQMJvhzOnRe/giphy.webp",
              "https://i.giphy.com/media/m59zqS6G8jE9Ip4daQ/giphy.webp",
              "https://i.giphy.com/media/3oFzmi3wPYHptlhNT2/giphy.webp",
              "https://i.giphy.com/media/xT5LMAvRY92qUXj7dC/giphy.webp",
              "https://i.giphy.com/media/KxshBpu7r42gemZ5Cy/giphy.webp",
              "https://i.giphy.com/media/3ohrylo2puV7phiwso/giphy.webp",
              "https://i.giphy.com/media/hCp63osBu9CuI/giphy.webp",
            ]
            const randomPositiveGif = positiveGifs[Math.floor(Math.random() * positiveGifs.length)];
            const randomNegativeGif = negativeGifs[Math.floor(Math.random() * negativeGifs.length)];
            let shouldPrint = false
            const output = `${process.env.BETTERER_OUTPUT}`.replace(/\\n/g, '\n');
            console.log(output)
            multilineOutput = output.replace(/\\n/g, '\n');
            newErrors = multilineOutput
              .split('\n')
              .filter(line => {
                const isFixedIssuesSummary = line[0] === "-"
                const isNewIssuesSummary = line[0] === "+"
                if (isFixedIssuesSummary)
                  fixedIssuesCount = getNumber(line)
                if (isNewIssuesSummary)
                  newIssuesCount = getNumber(line)
                return isFixedIssuesSummary || isNewIssuesSummary
              }).filter(line => {
                return line.substring(1)
              })
            .join('\n');
            console.log(multilineOutput)
            // ![avatar](${context.payload.comment.user.avatar_url})
            const gifMessage = `\n\n![Gif!](${fixedIssuesCount > newIssuesCount ? randomPositiveGif : randomNegativeGif})`
            const quickSummary = fixedIssuesCount > newIssuesCount ? 
              `@${context.payload.comment.user.login} is improving our codebase! ðŸ™Œ` : 
              `@${context.payload.comment.user.login} adds issues to our codebase! ðŸ¤•`
            const summaryMessage = `| ![Thank you!](https://avatars.githubusercontent.com/u/${context.payload.comment.user.id}?s=40&v=4) | ${quickSummary} |\n| ------------- | ------------- |\n| **CHANGE TYPE** | **AMOUNT** |\n| âœ… Fixed issues | \`${fixedIssuesCount}\` |\n| ðŸ”¥ New issues | \`${newIssuesCount}\` |`
            const botMessage = `**ðŸ¤– BOT:** Betterer results file was updated as requested by @${context.payload.comment.user.login}\n\n`
            const nothingToReportMessage = `Seems like there are no changes, sooo... Carry on!`
            const fullMessage = fixedIssuesCount || newIssuesCount ? 
              `${botMessage}${summaryMessage}${gifMessage}` :
              `${botMessage}${nothingToReportMessage}`
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${fullMessage}`,
            })



#      - name: Add comment
#        uses: actions/github-script@v4
#        with:
#          script: |
#            github.issues.createComment({
#              issue_number: context.issue.number,
#              owner: context.repo.owner,
#              repo: context.repo.repo,
#              body: `âœ… Updated betterer file! \`\`\`${JSON.stringify(context.payload,null,2)}\`\`\``,
#            });
# sdfsdfgs
# aasddsa
# user.avatar_url  - https://avatars.githubusercontent.com/u/5477821?v=4
# user.login  - Evilweed
#asd
#asdsd
#asd
#asldj
#asd
#asd
#asdlkjasasddaaadsasd asd
