name: Update betterer

on:
  issue_comment:
    types:
      - created

jobs:
  update-betterer-aa:
    runs-on: ubuntu-latest
    if: ${{ github.event.comment.body == 'a' }}
    env:
      FORCE_COLOR: '1'
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 16.3
      - name: Install dependencies
        run: yarn --frozen-lockfile --non-interactive --no-progress
#      - name: Typecheck
#        uses: computerjazz/typescript-error-reporter-action@v1.0.11
#        with:
#          project: tsconfig-strict.json
#          repo_token: "${{ secrets.GITHUB_TOKEN }}"
      - name: Incremental code quality check
        run: echo "::set-output name=betterer-output::$(CI=0 yarn betterer --update)\n"
      - name: setup git config
        run: |
          # setup the username and email. I tend to use 'GitHub Actions Bot' with no email by default
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
      - name: commit
        env:
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          # Stage the file, commit and push
          git checkout $PR_BRANCH
          git add .betterer.results
          git commit -m "Updated Betterer results file"
          git push
      - name: Add comment
        uses: actions/github-script@v4
        with:
          script: |
            const {owner, repo} = context.issue
            github.reactions.createForIssueComment({
              owner,
              repo,
              comment_id: context.payload.comment.id,
              content: "+1",
            });
      - name: Add comment
        uses: actions/github-script@v4
        env:
          BETTERER_OUTPUT: ${{join(steps.run_tests.outputs.*, '\n')}}
        with:
          script: |
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
                ✅ @${context.payload.comment.user.login}: I've updated betterer results file!  
                ![giphy-3](${context.payload.comment.user.avatar_url})
                \`\`\`
                ${process.env.BETTERER_OUTPUT}
                \`\`\`
              `,
            });
#      - name: Add comment
#        uses: actions/github-script@v4
#        with:
#          script: |
#            github.issues.createComment({
#              issue_number: context.issue.number,
#              owner: context.repo.owner,
#              repo: context.repo.repo,
#              body: `✅ Updated betterer file! \`\`\`${JSON.stringify(context.payload,null,2)}\`\`\``,
#            });
# sdfsdfgs
# aasddsa
# user.avatar_url  - https://avatars.githubusercontent.com/u/5477821?v=4
# user.login  - Evilweed
#asd
#asdsd
#asdasd
#asldjkhsdf
